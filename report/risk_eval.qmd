---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Risk evaluation

Analyze the pension model results previously created.

Summarize the results for each scenario (each row of the result tibble) by unnesting it to allow access to all of the sims and all of the years, calculating summary statistics such as percentiles of the funded ratio or more-sophisticated measures of risk (to come, after Gang's analysis).


## Setup

```{r}
#| label: setup
#| output: false

source(here::here("report", "_common.R"))

```


## Get saved pension model results

Get data, show the nested data, and show the head and tail of one scenario unnested.

```{r}
#| label: get-penmod-results

# result <- readRDS(here::here("data", "penmod_results.rds"))
result <- readRDS(here::here("data", "acli_normal_penmod.rds"))

result

result |> 
  select(-irmat) |> 
  unnest(penmod)

result |> 
  select(-irmat) |> 
  filter(scenario=="phi_m.05") |> 
  unnest(col=penmod) |> 
  ht()

```


Take a look at a couple of simple results before running Gang's risk measures. Here we look at the median funded ratio at 30 years.

Notes:

-   Modeled median funded ratio is always slightly higher than the random normal counterpart, even though mean log return and sd of log return is virtually identical for both

```{r}
#| label: explore
#| output: true

result |> 
  select(-c(irmat, mean_rnorm, sd_rnorm)) |> 
  # filter(scenario %in% c("baseline", "phi_m.05")) |> 
  unnest(col=penmod) |> 
  filter(year==30) |> 
  summarise(
    mean_logreturn=first(mean_logreturn),
    frmdn=median(fr), .by=c(scenario, porttype, version)) |> 
  pivot_wider(names_from = version, values_from = frmdn) |> 
  relocate(rnormal, .before=model) |> 
  mutate(diff_vsrnorm=model - rnormal)

```




## Construct risk measures from pension model results

### Functions to implement Gang's risk measures

Put the functions here for now. Later put them in a separate file.

```{r}
#| label: risk-functions




```



```{r}
#| label: risk-measures




```





