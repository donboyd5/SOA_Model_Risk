---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Preparation of head-to-head data for comparison of ESG scenarios to normal returns

## Setup

```{r}
#| label: setup
#| output: false

source(here::here("report", "_common.R"))

```

```{r}
#| label: get-acli
#| output: false

acli <- readRDS(here::here("data", "acli_scenarios.rds"))
glimpse(acli)

```

## Prepare one or more random normal comparisons

For now, this section takes an ACLI baseline run, constructs a simple portfolio with the weights shown below; possibilities shown below that:

![](images/clipboard-2799656906.png)

![](images/clipboard-4182082288.png)

```{r}
#| label: prepare-acli-data
#| output: false

scenario <- acli |> 
  filter(scenario=="baseline")

glimpse(scenario)
count(scenario, year)
count(scenario, fnbase, fdesc)
summary(scenario)

# construct a portfolio
port_weights <- read_csv(
"fnbase, weight
aggr, .2
fixed, .2
us, .3
int, .3")
port_weights

sum(port_weights$weight) # verify equals 1

portfolio <- scenario |> 
  filter(fnbase %in% port_weights$fnbase) |> 
  arrange(fnbase, sim, year) |> 
  left_join(port_weights, by = join_by(fnbase)) |> 
  mutate(portreturn=return * weight) |> 
  select(fnbase, sim, year, portreturn) |> 
  summarise(portreturn=sum(portreturn), .by=c(sim, year)) |> 
  mutate(portreturn=ifelse(year==0, 0, portreturn)) |> 
  mutate(portfolio=cumprod(1 + portreturn), .by=sim)
  
portfolio

grand <- portfolio |> 
  filter(year > 0) |> 
  summarise(mean=mean(portreturn), sd=sd(portreturn))

# generate similar random normal

rnreturn <- rnorm(n=nrow(portfolio) - 1, mean=grand$mean, sd=grand$sd)

rnportfolio <- portfolio |> 
  select(sim, year) |> 
  filter(year!=0) |>
  mutate(rnreturn=rnorm(n(), mean=grand$mean, sd=grand$sd)) |> 
  mutate(rnportfolio=cumprod(1 + rnreturn), .by=sim)

comp <- left_join(portfolio, rnportfolio,
                  by = join_by(sim, year)) |> 
  mutate(rnreturn=ifelse(year==0, 0, rnreturn),
         rnportfolio=ifelse(year==0, 1, rnportfolio))

ystats <- comp |> 
  filter(year > 0) |> 
  summarise(mean_acli=mean(portreturn), sd_acli=sd(portreturn),
            mean_rn=mean(rnreturn), sd_rn=sd(rnreturn), .by=year) |> 
  pivot_longer(-year) |> 
  separate(name, c("stat", "type"))


```

## Comparison of ACLI baseline to random normal with same mean and SD

### Observations

-   Grand mean and sd about the same
-   ACLI appears to have some modest autocorrelation in returns that random normal does not
-   ACLI portfolio appears to have slightly thinner tails than normal (can quantify this)
-   We need to decide on 2? portfolios to examine, and then run them through penmod.
-   However, these results suggest (to me) that we're unlikely to see large differences in risk measures vs. random normal. But will be good to examine more thoughtful portfolios and use actual risk measures.

### Grand mean and standard deviations - ACLI and random normal

```{r}

comp |> 
  filter(year > 0) |> 
  summarise(mean_acli=mean(portreturn), sd_acli=sd(portreturn),
            mean_rn=mean(rnreturn), sd_rn=sd(rnreturn))


```

### Mean and standard deviation by year

```{r}

ystats |> 
  filter(stat=="mean") |> 
  ggplot(aes(year, value, colour=type)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = grand$mean) +
  ggtitle("Arithmetic mean return by year")

ystats |> 
  filter(stat=="sd") |> 
  ggplot(aes(year, value, colour=type)) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = grand$sd) +
  ggtitle("Standard deviation by year")

```

### Accumulation at year 30

```{r}


p <-  c(0, .05, .1, 0.25, 0.5, 0.75, .9, .95, 1)

y30 <- comp |> 
  filter(year==30) |>
  select(sim, year, portfolio, rnportfolio) |> 
  pivot_longer(c(portfolio, rnportfolio)) |> 
  group_by(name) |> 
  summarise(
    quantiles = list(quantile(value, probs = p))
    ) |> 
  unnest_wider(quantiles) |> 
  ungroup() |> 
  rename_with(~paste0("q", p * 100),
              .cols=-name)
y30

```
