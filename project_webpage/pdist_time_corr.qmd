---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Investment returns correlated over time

<!-- A multivariate normal distribution with returns correlated over time, parameterized by mean, standard deviation, and a correlation matrix. -->



```{r}

# Define parameters
mu <- 0.07
phi <- -0.20  # the coefficient on AR(1) term
sd <- 0.10
nyears <- 50  # number of years to simulate
nsims <- 1000

gmat <- function(seed){
  set.seed(seed)
  m <- matrix(nrow=nsims, ncol=nyears)
  y1 <- rnorm(nsims, mean=mu, sd=sd) # year 1
  y1 <- scale_dist(y1, mu, sd) # scale year 1
  m[, 1] <- y1
  
  for (t in 2:nyears) {
    e <- rnorm(nsims, mean = 0, sd = sd)
    # e <- scale_dist(e, 0, sd)
    m[, t] <- mu + phi * (m[t-1] - mu) + e
  }
  m
}

f <- function(seed){
  m <- gmat(seed)
  
  return(tibble(seed=seed, meanmat=mean(m), sdmat=sd(m)) |> 
           mutate(esq=(mu - meanmat)^2 + (sd - sdmat)^2))
}

system.time(df <- map_dfr(1:10000, f))
# skim(df)

(bestseed <- df |> filter(row_number()==iclosest(0, df$esq)) |> pull(seed))

m <- gmat(bestseed)
mean(m); sd(m)
quantile(colMeans(m))
apply(m, 2, sd)




set.seed(bestseed)
ir1 <- rt(nyears * nsims, ir_df)




m <- f(1)

mean(m); sd(m)


# Initialize the series
m <- matrix(nrow=nsims, ncol=nyears)
y1 <- rnorm(nsims, mean=mu, sd=sd)
y1 <- scale_dist(y1, mu, sd)
m[, 1] <- y1

for (t in 2:nyears) {
  e <- rnorm(nsims, mean = 0, sd = sd)
  e <- scale_dist(e, 0, sd)
  m[, t] <- mu + phi * (m[t-1] - mu) + e
}

mean(m); sd(m)
mean(m[, 1]); sd(m[, 1])



m[1:10, 1:5]
m[990:1000, 45:50]
quantile(m)


df <- as_tibble(m) |> 
  mutate(sim=row_number()) |> 
  pivot_longer(-sim, names_to = "year", values_to = "ir") |> 
  mutate(year=str_remove(year, "V") |> as.integer())
skim(df)
count(df, year)
count(df, sim) |> ht()


tibble(year=1:length(X), ir=X) |> 
  filter(row_number()<=50) |> 
  ggplot(aes(year, ir)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = mu, linetype="dashed") +
  theme_bw()


```



```{r}

# Define parameters
mu <- 0.07
phi <- -0.20  # the coefficient on AR(1) term
sd <- 0.10
n <- 1000  # number of years to simulate

# Initialize the series
X <- numeric(n)
X[1] <- mu  # start the series at the mean

# Generate the AR(1) series
set.seed(123)  # for reproducibility
for (t in 2:n) {
  e <- rnorm(1, mean = 0, sd = sd)
  X[t] <- mu + phi * (X[t-1] - mu) + e
}

# Plot the series
plot(X[1:50], type = "l", main = "Simulated Investment Returns", ylab = "Return", xlab = "Year")

tibble(year=1:length(X), ir=X) |> 
  filter(row_number()<=50) |> 
  ggplot(aes(year, ir)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = mu, linetype="dashed") +
  theme_bw()


```

